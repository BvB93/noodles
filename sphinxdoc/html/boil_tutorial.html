

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Real World Tutorial 2: Boil, a make tool. &mdash; Noodles 0.2.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Noodles 0.2.0 documentation" href="index.html"/>
        <link rel="next" title="Boil: the source" href="boil_source.html"/>
        <link rel="prev" title="Real World Tutorial 1: Translating Poetry" href="poetry_tutorial.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Noodles
          

          
            
            <img src="_static/nlesc-logo-white.svg" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="eating.html">Eating noodles (user docs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="cooking.html">Cooking of Noodles (library docs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="first_steps.html">First Steps</a></li>
<li class="toctree-l1"><a class="reference internal" href="poetry_tutorial.html">Real World Tutorial 1: Translating Poetry</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Real World Tutorial 2: Boil, a make tool.</a><ul>
<li class="toctree-l2"><a class="reference internal" href="boil_source.html">Boil: the source</a></li>
<li class="toctree-l2"><a class="reference internal" href="#make-j">&#8220;make -j&#8221;</a></li>
<li class="toctree-l2"><a class="reference internal" href="#functions">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#friendly-output-and-error-handling">Friendly output and error handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Development documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="scheduler.html">The Noodles Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="brokers.html">Co-routine brokers</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Noodles</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Real World Tutorial 2: Boil, a make tool.</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/boil_tutorial.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="real-world-tutorial-2-boil-a-make-tool">
<h1>Real World Tutorial 2: Boil, a make tool.<a class="headerlink" href="#real-world-tutorial-2-boil-a-make-tool" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="boil_source.html">Boil: the source</a></li>
</ul>
</div>
<p>This tutorial should teach you the basics of using Noodles to parallelise a Python program. We will see some of the quirks that come with programming in a strict functional environment.</p>
<div class="section" id="make-j">
<h2>&#8220;make -j&#8221;<a class="headerlink" href="#make-j" title="Permalink to this headline">¶</a></h2>
<p>The first of all workflow engines is called &#8216;make&#8217;. It builds a tree of interdepending jobs and executes them in order. The &#8216;-j&#8217; option allows the user to specify a number of jobs to be run simultaneously to speed up execution. The syntax of make is notoriously terse, partly due to it&#8217;s long heritage (from 1976). This example shows how we can write a script that compiles a C/C++ program using GCC or CLANG, then how we can parallelise it using Noodles. We have even included a small C++ program to play with!</p>
</div>
<div class="section" id="functions">
<h2>Functions<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h2>
<p>Compiling a C program is a two-stage process. First we need to compile each source file to an object file, then link these object files to an executable. The <code class="xref py py-func docutils literal"><span class="pre">compile_source()</span></code> function looks like this:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@schedule</span>
<span class="k">def</span> <span class="nf">compile_source</span><span class="p">(</span><span class="n">source_file</span><span class="p">,</span> <span class="n">object_file</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;cc&#39;</span><span class="p">],</span> <span class="s1">&#39;-c&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;cflags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> \
            <span class="o">+</span> <span class="p">[</span><span class="n">source_file</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">object_file</span><span class="p">],</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">check_returncode</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">object_file</span>
</pre></div>
</td></tr></table></div>
<p>It takes a source file, an object file and a configuration object. This configuration contains all the information on which compiler to use, with which flags, and so on. If the compilation was successful, the name of the object file is returned. This last bit is crucial if we want to include this function in a workflow.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Each dependency (in this case linking to an excecutable requires compilation first) should be represented by return values of one function ending up as arguments to another function.</p>
</div>
<p>The function for linking object files to an executable looks very similar:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@schedule</span>
<span class="k">def</span> <span class="nf">link</span><span class="p">(</span><span class="n">object_files</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;cc&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">object_files</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]]</span> \
            <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ldflags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">check_returncode</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>In this case the function takes a list of object file names and the same configuration object that we saw before. Again, this function returns the name of the target executable file. The caller of this function already knows the name of the target file, but we need it to track dependencies between function calls.</p>
<p>Since both the <code class="xref py py-func docutils literal"><span class="pre">link()</span></code> and the <code class="xref py py-func docutils literal"><span class="pre">compile_source()</span></code> functions do actual work that we&#8217;d like to see being done in a concurrent environment, they need to be decorated with the <code class="xref py py-func docutils literal"><span class="pre">schedule()</span></code> decorator.</p>
<p>One of the great perks of using Make, is that it skips building any files that are already up-to-date with the source code. If our little build script is to compete with such efficiency, we should do the same!</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_out_of_date</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">deps</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="n">f_stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
        <span class="n">d_stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">d_stat</span><span class="o">.</span><span class="n">st_mtime_ns</span> <span class="o">&gt;</span> <span class="n">f_stat</span><span class="o">.</span><span class="n">st_mtime_ns</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="bp">False</span>
</pre></div>
</td></tr></table></div>
<p>This function takes a file <code class="xref py py-obj docutils literal"><span class="pre">f</span></code> and a list of files <code class="xref py py-obj docutils literal"><span class="pre">deps</span></code> and checks the modification dates of all of the files in <code class="xref py py-obj docutils literal"><span class="pre">deps</span></code> against that of <code class="xref py py-obj docutils literal"><span class="pre">f</span></code>.</p>
<p>One of the <em>quirks</em>, that we will need to deal with, is that some <em>logic</em> in a program needs to have knowledge of the actual objects that are computed, not just the possibility of such an object in the future. When designing programs for Noodles, you need to be aware that such logic can only be performed <em>inside</em> the functions. Say we have a condition under which one or the other action needs to be taken, and this condition depends on the outcome of a previous element in the workflow. The actual Python <code class="xref py py-obj docutils literal"><span class="pre">if</span></code> statement evaluating this condition needs to be inside a scheduled function. One way around this, is to write a wrapper:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@schedule</span>
<span class="k">def</span> <span class="nf">cond</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="n">when_true</span><span class="p">,</span> <span class="n">when_false</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">predicate</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">when_true</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">when_false</span>
</pre></div>
</td></tr></table></div>
<p>However, there is a big problem with this approach! The Noodles engine sees two arguments to the <code class="xref py py-obj docutils literal"><span class="pre">cond</span></code> function that it wants to evaluate before heading into the call to <code class="xref py py-obj docutils literal"><span class="pre">cond</span></code>. Both arguments will be evaluated before we can even decide which of the two we should use! We will present a solution to this problem at a later stage, but for now we will have to work our way around this by embedding the conditional logic in a more specific function.</p>
<p>In this case we have the function <code class="xref py py-obj docutils literal"><span class="pre">is_out_of_date</span></code> that determines whether we need to recompile a file or leave it as it is. The second stage, linking the object files to an executable, only needs to happen if any of the object files is younger than the executable. However these object files are part of the logic inside the workflow! The conditional execution of the linker needs to be called by another scheduled function:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@schedule</span>
<span class="k">def</span> <span class="nf">get_target</span><span class="p">(</span><span class="n">obj_files</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">is_out_of_date</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">],</span> <span class="n">obj_files</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">link</span><span class="p">(</span><span class="n">obj_files</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">message</span><span class="p">(</span><span class="s2">&quot;target is up-to-date.&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Since we need the answer to <code class="xref py py-func docutils literal"><span class="pre">is_out_of_date()</span></code> in the present, the <code class="xref py py-func docutils literal"><span class="pre">is_out_of_date()</span></code> function cannot be a scheduled function. Python doesn&#8217;t know the truth value of a <code class="xref py py-class docutils literal"><span class="pre">PromisedObject</span></code>. The <code class="xref py py-obj docutils literal"><span class="pre">message</span></code> function is not a special function; it just prints a message and returns a value (optional second argument). We still need to optionalise the compilation step. Since all of the information needed to decide whether to compile or not is already present, we can make this a normal Python function; there is no need to schedule anything (even though everything would still work if we did):</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_object_file</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">src_file</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">obj_path</span> <span class="o">=</span> <span class="n">object_filename</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">src_file</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="n">src_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">src_file</span><span class="p">)</span>

    <span class="n">deps</span> <span class="o">=</span> <span class="n">dependencies</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_out_of_date</span><span class="p">(</span><span class="n">obj_path</span><span class="p">,</span> <span class="n">deps</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">compile_source</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="n">obj_path</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obj_path</span>
</pre></div>
</td></tr></table></div>
<p>The <code class="xref py py-obj docutils literal"><span class="pre">object_filename</span></code> is a little helper function creating a sensible name for the object file; also it makes sure that the directory in which the object file is placed exists. <code class="xref py py-obj docutils literal"><span class="pre">dependencies</span></code> Runs the compiler with &#8216;-MM&#8217; flags to obtain the header dependencies of the C-file.</p>
<p>We are now ready to put these functions together in a workflow!</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_target</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;srcdir&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;srcdir&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="p">]</span>

    <span class="n">files</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span>
        <span class="n">find_files</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ext&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">obj_files</span> <span class="o">=</span> <span class="n">noodles</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
        <span class="n">get_object_file</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">src_file</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">src_dir</span><span class="p">,</span> <span class="n">src_file</span> <span class="ow">in</span> <span class="n">files</span>
        <span class="p">])</span>

    <span class="k">return</span> <span class="n">get_target</span><span class="p">(</span><span class="n">obj_files</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Let&#8217;s go through this step-by-step. The <code class="xref py py-obj docutils literal"><span class="pre">make_target</span></code> function takes one argument, the config object. We obtain from the configuration the directories to search for source files. We then search these directories for any files with the correct file extension, stored in <code class="xref py py-obj docutils literal"><span class="pre">config['ext']</span></code>. The variable <code class="xref py py-obj docutils literal"><span class="pre">files</span></code> now contains a list of pairs, each pair having a directory and file name. So far we have not yet used any Noodles code.</p>
<p>Next we pass each source file through the <code class="xref py py-obj docutils literal"><span class="pre">get_object_file</span></code> function in a list comprehension. The resulting list contains both <code class="xref py py-class docutils literal"><span class="pre">PromisedObject</span></code> and string values; strings for all the object files that are already up-to-date. To pass this list to the linking stage we have to make sure that Noodles understands that the list is something that is being promised. If we were to pass it as is, Noodles just sees a list as an argument to <code class="xref py py-obj docutils literal"><span class="pre">get_target</span></code> and doesn&#8217;t look any deeper.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Every <code class="xref py py-obj docutils literal"><span class="pre">PromisedObject</span></code> has to be passed as an argument to a scheduled function in order to be evaluated. To pass a list to a scheduled function, we have to convert the list of promises into a promise of a list.</p>
</div>
<p>The function <code class="xref py py-func docutils literal"><span class="pre">gather()</span></code> solves this little problem; it&#8217;s definition is very simple:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@schedule</span>
<span class="k">def</span> <span class="nf">gather</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<p>Now that the variable <code class="xref py py-obj docutils literal"><span class="pre">obj_files</span></code> is a <code class="xref py py-class docutils literal"><span class="pre">PromisedObject</span></code>, we can pass it to <code class="xref py py-obj docutils literal"><span class="pre">get_target</span></code>, giving us the final workflow. Running this workflow can be as simple as <code class="docutils literal"><span class="pre">run_single(wf)</span></code> or <code class="docutils literal"><span class="pre">run_parallel(wf,</span> <span class="pre">n_threads=4)</span></code>.</p>
</div>
<div class="section" id="friendly-output-and-error-handling">
<h2>Friendly output and error handling<a class="headerlink" href="#friendly-output-and-error-handling" title="Permalink to this headline">¶</a></h2>
<p>The code as defined above will run, but if the compiler gives error messages it will crash in a very ugly manner. Noodles has some features that will make our fledgeling Make utility much prettier. We can decorate our functions further with information on how to notify the user of things happening:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@schedule_hint</span><span class="p">(</span><span class="n">display</span><span class="o">=</span><span class="s2">&quot;Compiling {source_file} ... &quot;</span><span class="p">,</span>
               <span class="n">confirm</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_source</span><span class="p">(</span><span class="n">source_file</span><span class="p">,</span> <span class="n">object_file</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>The <code class="xref py py-func docutils literal"><span class="pre">schedule_hint()</span></code> decorator attaches hints to the scheduled function. These hints can be used in any fashion we like, depending on the workers that we use to evaluate the workflow. In this case we use the <code class="xref py py-func docutils literal"><span class="pre">run_logging()</span></code> worker, with the <code class="xref py py-class docutils literal"><span class="pre">SimpleDisplay</span></code> class to take care of screen output:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">SimpleDisplay</span><span class="p">(</span><span class="n">error_filter</span><span class="p">)</span> <span class="k">as</span> <span class="n">display</span><span class="p">:</span>
    <span class="n">noodles</span><span class="o">.</span><span class="n">run_logging</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n_threads</span><span class="p">,</span> <span class="n">display</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="xref py py-obj docutils literal"><span class="pre">error_filter</span></code> function determines what errors are expected and how we print the exceptions that are caught. In our case we expect exceptions of type <code class="xref py py-exc docutils literal"><span class="pre">subprocess.CalledProcessError</span></code> in the case of a compiler error. Otherwise the exception is unexpected and should be treated as a bug in Boil!</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">error_filter</span><span class="p">(</span><span class="n">xcptn</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xcptn</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">xcptn</span><span class="o">.</span><span class="n">stderr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></div>
</td></tr></table></div>
<p>The <code class="xref py py-obj docutils literal"><span class="pre">display</span></code> tag in the hinst tells the <code class="xref py py-obj docutils literal"><span class="pre">display</span></code> object to print a text when the job is started.
The <code class="xref py py-obj docutils literal"><span class="pre">confirm</span></code> flag in the hints tells the <code class="xref py py-obj docutils literal"><span class="pre">display</span></code> object that a function is error-prone and to draw a green checkmark on success and a red X in case of failure.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>You should now be able to fully understand the sourcecode of Boil! Try it out on the sample code provided:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&gt; ./boil --help
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre><span></span>usage: boil [-h] [-j N_THREADS] [-dumb] target

Compile software. Configuration is in &#39;boil.ini&#39;.

positional arguments:
  target        target to build, give &#39;list&#39; to list targets.

optional arguments:
  -h, --help    show this help message and exit
  -j N_THREADS  number of threads to run simultaneously.
  -dumb         print info without special term codes.
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&gt; cat boil.ini
</pre></div>
</div>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[generic]</span>
<span class="na">objdir</span> <span class="o">=</span> <span class="s">obj</span>
<span class="na">ldflags</span> <span class="o">=</span> <span class="s">-lm</span>
<span class="na">cflags</span> <span class="o">=</span> <span class="s">-g -std=c++11 -O2 -fdiagnostics-color -Wpedantic</span>
<span class="na">cc</span> <span class="o">=</span> <span class="s">g++</span>
<span class="na">ext</span> <span class="o">=</span> <span class="s">.cc</span>

<span class="k">[main]</span>
<span class="na">srcdir</span> <span class="o">=</span> <span class="s">main</span>
<span class="na">target</span> <span class="o">=</span> <span class="s">hello</span>
<span class="na">modules</span> <span class="o">=</span> <span class="s">../src</span>

<span class="k">[test]</span>
<span class="na">srcdir</span> <span class="o">=</span> <span class="s">test</span>
<span class="na">target</span> <span class="o">=</span> <span class="s">unittests</span>
<span class="na">modules</span> <span class="o">=</span> <span class="s">../src</span>

<span class="k">[clean]</span>
<span class="na">command</span> <span class="o">=</span> <span class="s">rm -rf ${generic:objdir} ${test:target} ${main:target}</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&gt; ./boil main -j4
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre><span></span>╭─(Building target hello)
│   Compiling src/mandel.cc ...                   (✔)
│   Compiling src/common.cc ...                   (✔)
│   Compiling src/render.cc ...                   (✔)
│   Compiling src/iterate.cc ...                  (✔)
│   Compiling src/julia.cc ...                    (✔)
│   Compiling main/main.cc ...                    (✔)
│   Linking ...                                   (✔)
╰─(success)
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="boil_source.html" class="btn btn-neutral float-right" title="Boil: the source" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="poetry_tutorial.html" class="btn btn-neutral" title="Real World Tutorial 1: Translating Poetry" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015-2016, Johan Hidding, Felipe Zapata, Berend Weel.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>